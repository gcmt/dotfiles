#!/usr/bin/env python

import os
import sys
import i3ipc
import argparse
from html import escape
from subprocess import run, PIPE

# Turn windows into formatted lines to be passed to Rofi.
# Pango markup is supported if the '-markup-rows' Rofi option is used:
# https://developer.gnome.org/pango/stable/PangoMarkupFormat.html
def format_windows(windows):
    dimcolor = '#797d84'
    for w in windows:
        wsname = w.workspace().name
        ws = '$' if wsname == '__i3_scratch' else wsname
        row = f"<span foreground='{dimcolor}'>{escape(ws)}</span>   "
        if wsname == '__i3_scratch':
            row += f"<span foreground='{dimcolor}'>{escape(w.name)}</span>"
        else:
            row += f"<b>{escape(w.name)}</b>" if w.focused else escape(w.name)
        yield row


# Get windows of all workspaces. If the 'scratchpad' argument is given and it's
# True, windows in the scratchpad workspace are also returned.
def get_windows(tree, scratchpad=True):
    windows = []
    for ws in tree.workspaces():
        windows += ws.leaves()
    windows.sort(key=lambda w: w.workspace().num)
    if scratchpad:
        windows += tree.scratchpad().leaves()
    return windows


# Fix various window properties.
def fix_windows(windows):
    for win in windows:
        if win.window_class == 'Firefox' and win.name == 'Library':
            win.name += ' - Mozilla Firefox'
        elif win.window_class == 'Nemo':
            win.name += ' - Nemo'
        elif win.window_class == 'git-cola':
            win.name += ' - Git Cola'
        yield win



# Execute rofi and return the user choice.
def rofi(windows, inputbar=True):

    try:
        selected = [w.focused for w in windows].index(1)
    except ValueError:
        selected = 0

    options  = ['-dmenu', '-i', '-format', 'i']
    options += ['-markup-rows', '-selected-row', str(selected)]

    lines = min(len(windows), 12)

    style  = ['-theme', 'main-light']
    style += ['-theme-str', f'listview {{ fixed-height: false; lines: {lines}; }}']

    if len(windows) <= lines:
        style += ['-theme-str', 'listview { scrollbar: false; }']

    if not inputbar:
        style += ['-theme-str', 'mainbox { children: [listview]; }']
        options += ['-kb-row-up', 'Up,Control+k,k', '-kb-row-down', 'Down,Control+j,Super+Tab,j']
        options += ['-kb-accept-entry', 'l,Return,Control+d', '-kb-cancel', 'Escape,q']
        options += ['-kb-custom-1', 'm', '-kb-custom-2', 'underscore']
        options += ['-kb-custom-3', 'o', '-kb-custom-4', 'Q']
    else:
        options += ['-kb-custom-1', 'Control+m', '-kb-custom-2', 'Super+underscore']
        options += ['-kb-custom-3', 'Control+o', '-kb-custom-4', 'Super+Q']

    input = "\n".join(format_windows(windows))
    cmd = ['rofi'] + options + style
    proc = run(cmd, input=input, stdout=PIPE, encoding='utf8')

    return proc.stdout.strip(), proc.returncode


# Parse command line arguments.
def parse_args():
    parser = argparse.ArgumentParser(description="Improved i3 window switcher")
    group1 = parser.add_mutually_exclusive_group(required=False)
    group1.add_argument('-inputbar', action='store_true', default=True, help="display the input bar")
    group1.add_argument('-no-inputbar', action='store_false', dest='inputbar', help="hide the input bar")
    group2 = parser.add_mutually_exclusive_group(required=False)
    group2.add_argument('-scratchpad', action='store_true', default=True, help="include scratchpad windows")
    group2.add_argument('-no-scratchpad', action='store_false', dest='scratchpad', help="exclude scratchpad windows")
    return parser.parse_args()


def main():

    args = parse_args()
    i3 = i3ipc.Connection()
    tree = i3.get_tree()

    windows = get_windows(tree, args.scratchpad)
    if not windows:
        sys.exit(0)

    windows = list(fix_windows(windows))

    # 'choice' will be empty when pressing -kb-cancel but it will be -1 when
    # pressing -kb-accept-entry with nothing selected
    choice, exitcode = rofi(windows, args.inputbar)
    if not choice or choice == '-1':
        sys.exit(0)

    win = windows[int(choice)]

    # -kb-accept-entry
    if exitcode == 0:
        # focus the selected window
        win.command('focus; floating disable')
        sys.exit(0)

    # -kb-custom-1
    if exitcode == 10:
        # move the selected window to the current workspace
        num = tree.find_focused().workspace().num
        win.command(f'move to workspace number {num}; floating disable')
        sys.exit(0)

    # -kb-custom-2
    if exitcode == 11:
        # move the selected window to the scratchpad
        win.command('move scratchpad')
        os.execv(sys.argv[0], sys.argv)

    # -kb-custom-3
    if exitcode == 12:
        # switch to drun
        os.execvp('rofi', ['rofi', '-show', 'drun'])

    # -kb-custom-4
    if exitcode == 13:
        # kill selected window
        run(['xkill', '-id', f"{win.window}"])
        os.execv(sys.argv[0], sys.argv)


if __name__ == '__main__':
    main()
