#!/usr/bin/env python

import i3ipc
import argparse


def parse_args():

    parser = argparse.ArgumentParser(description="i3 window rotation")
    parser.add_argument('-follow', action='store_true', help="follow current window")
    group = parser.add_mutually_exclusive_group(required=True)
    group.add_argument('-next', action='store_true', help="focus next window")
    group.add_argument('-prev', action='store_true', help="focus previous window")

    return parser.parse_args()


def main():

    args = parse_args()
    i3 = i3ipc.Connection()

    tree = i3.get_tree()
    focused = tree.find_focused()
    workspace = focused.workspace()

    ids = [w.window for w in workspace.leaves()]
    curpos = ids.index(focused.window)

    rotated = list(ids)
    if args.next:
        rotated.insert(0, rotated.pop())
    else:
        rotated.append(rotated.pop(0))

    for i in range(len(ids)):
        if ids[i] == rotated[i]:
            continue
        i3.command(f'[id="{ids[i]}"] swap container with id {rotated[i]}')
        k = ids.index(rotated[i])
        ids[i], ids[k] = ids[k], ids[i]

    if not args.follow:
        i3.command(f'[id="{rotated[curpos]}"] focus')


if __name__ == '__main__':
    main()
