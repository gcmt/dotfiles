#!/bin/bash

scriptname="$(basename "$0")"
pidfile="/run/user/$UID/$scriptname.pid"
out="/run/user/$UID/i3-last-window"

exec 200>"$pidfile"
if ! flock -n 200; then
	echo "$scriptname: already running" 2>&1
	exit 1
else
	echo $$ >&200
	echo > "$out"
fi

cleanup() {
	rm -f "$out" "$pidfile"
}

trap cleanup 0

last=
xprop -root -spy _NET_ACTIVE_WINDOW | while read -r line; do
	current="$(echo "$line" | grep -io "0x[a-f0-9]\\+")"
	if [[ "$current" == "$last" ]]; then
		continue
	fi
	if ! xprop -id "$last" >/dev/null 2>&1; then
		last=
	fi
	echo "$last" > "$out"
	last="$current"
done
