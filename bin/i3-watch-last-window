#!/bin/bash

basedir="$HOME/.run/i3"
lock="$basedir/i3-watch-last-window.pid"
out="$basedir/last-window"

if [[ -e "$lock" ]]; then
	echo "i3-watch-last-window: already running" 2>&1
	exit 1
fi

cleanup() {
	rm -f "$out" "$lock"
}
trap cleanup INT TERM EXIT

mkdir -p "$basedir"
echo $$ > "$lock"

echo "" > "$out"

last=
xprop -root -spy _NET_ACTIVE_WINDOW | while read -r line; do
	current="$(echo "$line" | grep -io "0x[a-f0-9]\\+")"
	if [[ "$current" == "$last" ]]; then
		continue
	fi
	if ! xprop -id "$last" >/dev/null 2>&1; then
		last=
	fi
	echo "$last" > "$out"
	last="$current"
done
