#!/bin/bash

state_file="/run/user/$UID/mediac.state"
mpv_fifo="/tmp/mpv.fifo"
profiles=(mpd mpv)

_notify() {
	dunstify -t 3000 -r 4234 "Mediakeys" "$1"
}

if [[ -f "$state_file" ]]; then
	profile="$(cat "$state_file")"
else
	profile="${profiles[0]}"
	echo "$profile" > "$state_file"
fi

if [[ "$1" == cycle ]]; then
	for i in "${!profiles[@]}"; do
		if [[ "${profiles[$i]}" == "$profile" ]]; then
			profile="${profiles[$(( (i+1) % ${#profiles[@]} ))]}"
			echo "$profile" > "$state_file"
			break
		fi
	done
	echo "Active profile: $profile"
	_notify "Profile:  $profile"
	exit
fi

if [[ "$profile" == mpv ]]; then

	if ! pgrep -x mpv >/dev/null; then
		echo 1>&2 "mpv not running"
		_notify "Mpv not running"
		exit 1
	fi

	case "$1" in
		F5) echo stop > "$mpv_fifo" ;;
		F6) echo cycle pause > "$mpv_fifo" ;;
		F7) echo seek -3 > "$mpv_fifo" ;;
		F8) echo seek 3 > "$mpv_fifo" ;;
		*) exit 1 ;;
	esac

elif [[ "$profile" == mpd ]]; then

	case "$1" in
		F5) i3-focus -c URxvt -t '^ncmpcpp$' -kill -fallback 'urxvt -name floating -e ncmpcpp' ;;
		F6) mpc toggle ;;
		F7) mpc prev ;;
		F8) mpc next ;;
		*) exit 1 ;;
	esac

fi
