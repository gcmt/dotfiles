#!/bin/bash

cmd='playlist'
if [[ "$*" =~ -add($| ) ]]; then
	cmd='listall'
fi

opts="-dmenu -i -markup-rows"
opts="$opts -kb-custom-1 'Control+a' -kb-custom-2 'Control+q'"
opts="$opts -theme 'main-light'"

current="$(mpc current -f '[%artist%  %title%]|[%file%]')"
opts="$opts -select \"$current\""

files=()
while read -r line; do
	files+=( "$line" )
done < <(mpc "$cmd" -f "%file%")

if [[ "$cmd" == 'playlist' ]]; then
	opts="$opts -format d"
	opts="$opts -mesg 'Playlist: ${#files[@]} songs'"
else
	opts="$opts -format i"
	opts="$opts -mesg 'Browse: ${#files[@]} songs'"
fi

format="[<span foreground='##797d84'>%artist%</span>  %title%]|[%file%]"
idx="$(mpc "$cmd" -f "$format" | sed 's/&/&amp;/g' | eval "rofi $opts")"
rofi_exit=$?

if (( rofi_exit == 1 )); then
	exit 1
fi

case $rofi_exit in
	10)
		exec "$(realpath "$0")" -add
		;;
	11)
		exec "$(realpath "$0")"
		;;
	*)
		if [[ "$cmd" == 'playlist' ]]; then
			mpc play "$idx"
		else
			mpc add "${files[idx]}"
			mpc play "$(mpc playlist | wc -l)"
		fi
		;;
esac
