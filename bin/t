#!/bin/bash

session_name=$1

if [ -z "$session_name" ]
then
	session_list=$(tmux ls -F '#{session_activity}:#{session_name}' 2>/dev/null)
	if [ $? -ne 0 ]
	then
		# if tmux server is not running, use 'scratch' as default session name
		session_name=scratch
	else
		# find the last active session
		last_active_session=
		last_activity_delta=$(date '+%s')
		while IFS= read -r line
		do
			activity=$(echo $line | grep -o '^[0-9]\+')
			delta=$(expr $(date '+%s') - $activity)
			if [ $delta -lt $last_activity_delta ]
			then
				last_active_session=$(echo $line | sed 's/^[0-9]\+://')
				last_activity_delta=$delta
			fi
		done <<< "$session_list"
		session_name="$last_active_session"
	fi
fi

tmux has -t "$session_name" 2>/dev/null
if [ $? -ne 0 ]
then
	tmux new -s "$session_name" -d
fi

if [ -z "$TMUX" ]
then
	tmux attach -t "$session_name"
else
	tmux switchc -t "$session_name"
fi
