#!/bin/bash

target=$1
default="scratch"

# Find the last used session that is not $default or cmus
last_used_session() {
	local sessions="$(tmux ls -F '#{session_activity}:#S' 2>/dev/null)"
	if [[ -z "$sessions" ]]; then
		return 1
	fi
	local candidate session activity delta last_delta
	while IFS= read -r line; do
		candidate="$(echo $line | sed 's/^[0-9]\+://')"
		if [[ "$candidate" =~ $default|cmus ]]; then
			continue
		fi
		activity="$(echo $line | grep -o '^[0-9]\+')"
		delta=$(( $(date '+%s') - $activity ))
		if (( $delta < ${last_delta:-$(date '+%s')} )); then
			session="$candidate"
			last_delta=$delta
		fi
	done <<< "$sessions"
	echo "$session"
}

if [[ -z "$target" ]]; then
	target="$(last_used_session)"
	target="${target:-$default}"
fi

if ! tmux has -t "=$target" 2>/dev/null; then
	tmux new -ds "$target"
fi

if [[ -z "$TMUX" ]]; then
	exec tmux attach -t "=$target"
else
	tmux switchc -t "=$target"
fi
