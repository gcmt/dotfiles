#!/bin/bash


get_duration() {
	local n mod total=0
	for arg in "$@"; do
		n=$(echo "$arg" | grep -o '^[0-9]\+')
		(( $? != 0 )) && continue
		mod=$(echo "$arg" | grep -o '\([sm]$\|$\)')
		(( $? != 0 )) && continue
		case $mod in
			s) total=$(expr $total + $n);;
			m) total=$(expr $total + $n "*" 60);;
			*) total=$(expr $total + $n "*" 60);;
		esac
	done
	echo "$total"
}


start_timer() {
	local seconds="$(get_duration "$@")"
	if [[ -z "$seconds" ]]; then
		return 1
	fi
	local end="$(expr $(date +'%s') + "$seconds")"
	echo "timer_end=$end" > "$timer"
}


stop_timer() {
	rm -f "$timer"
}


timer="$HOME/.run/timer"

mkdir -p "$HOME/.run"

if [[ "$1" == start || "$1" =~ [0-9]+ ]]; then

	start_timer "$@" || exit 1

elif [[ "$1" == toggle ]]; then

	if [[ -e "$timer" ]]; then
		stop_timer
	else
		start_timer "$@" || exit 1
	fi

elif [[ "$1" == stop ]]; then

	stop_timer

else

	echo 2>&1 "Usage: timer [start|stop|toggle] [durations]"
	exit 1

fi
